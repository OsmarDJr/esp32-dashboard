<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Sensor - Gráfico Clean</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #f8f8f8;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #333;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    #chart-container {
      max-width: 300px;
      width: 100%;
      height: 150px;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: none;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="chart-container">
    <canvas id="sensorChart" height="150"></canvas>
  </div>

  <script>
    // Função callback para JSONP
    function callback(data) {
      const ultimos = data.slice(-100);

      const labels = ultimos.map(item => {
        const d = new Date(item.data);
        return d.toLocaleTimeString();
      });

      const temperaturas = ultimos.map(item => parseFloat(item.temperatura));
      const umidades = ultimos.map(item => parseFloat(item.umidade));

      const ctx = document.getElementById('sensorChart').getContext('2d');

      if (window.sensorChart) {
        window.sensorChart.data.labels = labels;
        window.sensorChart.data.datasets[0].data = temperaturas;
        window.sensorChart.data.datasets[1].data = umidades;
        window.sensorChart.update();
      } else {
        window.sensorChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Temperatura (°C)',
                data: temperaturas,
                borderColor: '#ff5722',
                backgroundColor: 'rgba(255, 87, 34, 0.2)',
                fill: true,
                tension: 0.2,
                pointRadius: 0,
              },
              {
                label: 'Umidade (%)',
                data: umidades,
                borderColor: '#2196f3',
                backgroundColor: 'rgba(33, 150, 243, 0.2)',
                fill: true,
                tension: 0.2,
                pointRadius: 0,
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { display: false },
                ticks: { maxTicksLimit: 5 }
              },
              y: {
                grid: { color: '#eee' },
                ticks: { maxTicksLimit: 4 }
              }
            },
            plugins: {
              legend: {
                labels: {
                  font: { size: 11 },
                  color: '#666'
                }
              },
              tooltip: {
                enabled: true,
                mode: 'nearest',
                intersect: false,
                padding: 6,
              }
            },
            elements: {
              line: { borderWidth: 2 },
            }
          }
        });
      }
    }

    // Carregar dados via JSONP a cada 10 segundos
    function carregarDados() {
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/AKfycbwaksid1fGdcobyDrMGhBdjILayk2zmsW8tIqk-w4bAAcvws7ezlMh-CnOhojL8-bmo/exec?callback=callback&_=' + new Date().getTime();
      document.body.appendChild(script);
      // Remove o script para evitar acúmulo
      script.onload = () => document.body.removeChild(script);
    }

    carregarDados();
    setInterval(carregarDados, 10000);
  </script>
</body>
</html>
